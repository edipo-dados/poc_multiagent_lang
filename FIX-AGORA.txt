â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸš€ FIX DEFINITIVO - COPIE TUDO E COLE DE UMA VEZ            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Execute este bloco completo (copie tudo e cole no terminal):

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Parar Ollama
pkill ollama
sleep 2

# Iniciar Ollama escutando em TODAS as interfaces
OLLAMA_HOST=0.0.0.0:11434 nohup ollama serve > /tmp/ollama.log 2>&1 &
sleep 5

# Verificar se estÃ¡ escutando (use ss ao invÃ©s de netstat)
echo "ğŸ” Verificando se Ollama estÃ¡ escutando em 0.0.0.0:11434..."
sudo ss -tlnp | grep 11434

# Testar conexÃ£o localhost
echo "ğŸ§ª Testando localhost..."
curl -s http://localhost:11434/api/tags > /dev/null && echo "âœ… localhost OK" || echo "âŒ localhost FALHOU"

# Testar conexÃ£o no IP da rede
echo "ğŸ§ª Testando IP da rede..."
curl -s http://172.31.5.241:11434/api/tags > /dev/null && echo "âœ… IP da rede OK" || echo "âŒ IP da rede FALHOU - adicionando firewall rules..."

# Adicionar regras de firewall
sudo iptables -I INPUT -s 172.16.0.0/12 -p tcp --dport 11434 -j ACCEPT
sudo iptables -I INPUT -s 172.31.0.0/16 -p tcp --dport 11434 -j ACCEPT
sudo iptables -I INPUT -s 127.0.0.1 -p tcp --dport 11434 -j ACCEPT

# Testar novamente
echo "ğŸ§ª Testando novamente apÃ³s firewall..."
curl -s http://172.31.5.241:11434/api/tags > /dev/null && echo "âœ… SUCESSO!" || echo "âŒ AINDA FALHOU"

# Atualizar .env
cat > .env << 'EOF'
DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/regulatory_ai
LLM_TYPE=ollama
OLLAMA_BASE_URL=http://172.31.5.241:11434
OLLAMA_MODEL=llama2
EOF

echo "âœ… .env atualizado"

# Reiniciar backend
echo "ğŸ”„ Reiniciando backend..."
docker compose restart backend

echo ""
echo "â³ Aguardando 10 segundos para backend iniciar..."
sleep 10

echo ""
echo "ğŸ§ª Testando API completa..."
curl -X POST http://localhost:8000/analyze \
  -H 'Content-Type: application/json' \
  -d '{"regulatory_text":"Test","repo_path":"/app/fake_pix_repo"}' \
  2>&1 | head -20

echo ""
echo "âœ… PRONTO! Verifique a resposta acima."
echo ""
echo "Se ainda tiver erro 'Connection refused', execute:"
echo "  docker compose logs backend --tail 50 | grep -i ollama"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

COPIE TODO O BLOCO ACIMA (desde # Parar Ollama atÃ© o final)
E COLE NO SEU TERMINAL EC2

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
