â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ðŸ”§ FIX SYSTEMD - Ollama estÃ¡ sendo gerenciado pelo systemd  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

O Ollama continua iniciando em 127.0.0.1 porque o systemd estÃ¡
sobrescrevendo a variÃ¡vel OLLAMA_HOST.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸš€ SOLUÃ‡ÃƒO: Configurar systemd para usar 0.0.0.0
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# 1. Verificar se systemd estÃ¡ gerenciando o Ollama
sudo systemctl status ollama

# 2. Criar diretÃ³rio de override
sudo mkdir -p /etc/systemd/system/ollama.service.d

# 3. Criar arquivo de configuraÃ§Ã£o
sudo tee /etc/systemd/system/ollama.service.d/override.conf > /dev/null << 'EOF'
[Service]
Environment="OLLAMA_HOST=0.0.0.0:11434"
EOF

# 4. Recarregar systemd
sudo systemctl daemon-reload

# 5. Reiniciar Ollama
sudo systemctl restart ollama

# 6. Aguardar
sleep 5

# 7. Verificar que agora estÃ¡ em 0.0.0.0
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "Verificando porta (DEVE mostrar 0.0.0.0:11434):"
sudo ss -tlnp | grep 11434
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# 8. Testar conexÃ£o no IP
curl -s http://172.31.5.241:11434/api/tags > /dev/null && echo "âœ… IP OK" || echo "âŒ IP FALHOU (firewall)"

# 9. Adicionar firewall rules
sudo iptables -I INPUT -s 172.16.0.0/12 -p tcp --dport 11434 -j ACCEPT
sudo iptables -I INPUT -s 172.31.0.0/16 -p tcp --dport 11434 -j ACCEPT
sudo iptables -I INPUT -s 127.0.0.1 -p tcp --dport 11434 -j ACCEPT

# 10. Testar novamente
echo "Testando apÃ³s firewall..."
curl -s http://172.31.5.241:11434/api/tags && echo "" && echo "âœ… SUCESSO!"

# 11. Atualizar .env
cat > .env << 'EOF'
DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/regulatory_ai
LLM_TYPE=ollama
OLLAMA_BASE_URL=http://172.31.5.241:11434
OLLAMA_MODEL=llama2
EOF

echo "âœ… .env atualizado"

# 12. Reiniciar backend
docker compose restart backend
echo "â³ Aguardando 10 segundos..."
sleep 10

# 13. Testar API
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ðŸ§ª Teste final da API:"
curl -X POST http://localhost:8000/analyze \
  -H 'Content-Type: application/json' \
  -d '{"regulatory_text":"RESOLUÃ‡ÃƒO BCB NÂº 789/2024","repo_path":"/app/fake_pix_repo"}' \
  | head -30

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "âœ… PRONTO! Se viu 'execution_id' acima, estÃ¡ funcionando!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

COPIE TODO O BLOCO ACIMA E COLE NO TERMINAL

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“‹ VERIFICAÃ‡Ã•ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ApÃ³s executar, vocÃª DEVE ver:

1. Na saÃ­da do ss:
   LISTEN 0 4096 0.0.0.0:11434 0.0.0.0:*
   (NÃƒO 127.0.0.1:11434)

2. No teste do IP:
   âœ… IP OK

3. No teste da API:
   {"execution_id":"...","change_detected":true,...}
   (NÃƒO "Connection refused")

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ› SE AINDA MOSTRAR 127.0.0.1
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Verifique o arquivo de configuraÃ§Ã£o:
cat /etc/systemd/system/ollama.service.d/override.conf

Deve mostrar:
[Service]
Environment="OLLAMA_HOST=0.0.0.0:11434"

Se nÃ£o mostrar, recrie manualmente:
sudo nano /etc/systemd/system/ollama.service.d/override.conf

Cole:
[Service]
Environment="OLLAMA_HOST=0.0.0.0:11434"

Salve (Ctrl+O, Enter, Ctrl+X) e execute:
sudo systemctl daemon-reload
sudo systemctl restart ollama

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
