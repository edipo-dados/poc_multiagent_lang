โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฏ FIX FINAL - O Ollama estรก em 127.0.0.1, precisa 0.0.0.0  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

PROBLEMA: Ollama escutando em 127.0.0.1:11434 (sรณ localhost)
SOLUรรO: Matar o processo e reiniciar em 0.0.0.0:11434

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ EXECUTE ESTES COMANDOS (copie tudo de uma vez):
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# Matar TODOS os processos do Ollama (forรงa)
pkill -9 ollama
sleep 2

# Verificar que nรฃo hรก mais processos
ps aux | grep ollama | grep -v grep

# Iniciar Ollama em 0.0.0.0:11434
OLLAMA_HOST=0.0.0.0:11434 nohup ollama serve > /tmp/ollama.log 2>&1 &
sleep 5

# Verificar que agora estรก em 0.0.0.0
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "Verificando porta 11434 (deve mostrar 0.0.0.0:11434):"
sudo ss -tlnp | grep 11434
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Testar localhost
echo "Testando localhost..."
curl -s http://localhost:11434/api/tags > /dev/null && echo "โ localhost OK" || echo "โ localhost FALHOU"

# Testar IP da rede
echo "Testando 172.31.5.241..."
curl -s http://172.31.5.241:11434/api/tags > /dev/null && echo "โ IP OK" || echo "โ IP FALHOU (firewall)"

# Se falhou no IP, adicionar firewall rules
sudo iptables -I INPUT -s 172.16.0.0/12 -p tcp --dport 11434 -j ACCEPT
sudo iptables -I INPUT -s 172.31.0.0/16 -p tcp --dport 11434 -j ACCEPT
sudo iptables -I INPUT -s 127.0.0.1 -p tcp --dport 11434 -j ACCEPT

# Testar novamente
echo "Testando novamente..."
curl -s http://172.31.5.241:11434/api/tags > /dev/null && echo "โ SUCESSO!" || echo "โ AINDA FALHOU"

# Mostrar resposta real para confirmar
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "Resposta do Ollama:"
curl -s http://172.31.5.241:11434/api/tags | head -5
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Atualizar .env
cat > .env << 'EOF'
DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/regulatory_ai
LLM_TYPE=ollama
OLLAMA_BASE_URL=http://172.31.5.241:11434
OLLAMA_MODEL=llama2
EOF

echo "โ .env atualizado"

# Reiniciar backend
docker compose restart backend
echo "โณ Aguardando backend iniciar (10 segundos)..."
sleep 10

# Testar API
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐งช Testando API completa:"
curl -X POST http://localhost:8000/analyze \
  -H 'Content-Type: application/json' \
  -d '{"regulatory_text":"RESOLUรรO BCB Nยบ 789/2024 - Teste","repo_path":"/app/fake_pix_repo"}' \
  2>&1 | head -30

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ Se vocรช viu 'execution_id' acima, FUNCIONOU!"
echo "โ Se viu 'Connection refused', veja os logs:"
echo "   docker compose logs backend --tail 50"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

IMPORTANTE: 
- Deve mostrar "0.0.0.0:11434" (nรฃo "127.0.0.1:11434")
- Se ainda mostrar 127.0.0.1, o Ollama nรฃo estรก respeitando OLLAMA_HOST

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ SE AINDA MOSTRAR 127.0.0.1:11434
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

O Ollama pode estar sendo iniciado por systemd. Verifique:

sudo systemctl status ollama

Se estiver ativo, pare e desabilite:

sudo systemctl stop ollama
sudo systemctl disable ollama

Depois execute os comandos acima novamente.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
